(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e=[`simple`,`variable`,`hostExpression`],t=t=>e.includes(t.type),n=(e=``,t=`simple`)=>({value:e,type:t}),r=(e=void 0)=>({value:e,type:`hostValue`}),i=(e=``,t=[])=>({stack:e,symbols:t}),a=()=>({causes:[],effects:[]}),o={'"':`"`,"'":`'`,"`":"`","(":`)`,"{":`}`,"[":`]`},s=(e,r)=>{let s={rules:[]},c=0,l=`find_outer_delimiter`,u=`reading_cause`,d=null,f=null,p=a(),m=i(),h=n(),g=!1,_=[],v=()=>{if(h.store){if(h.collectingString)h.value.split(``).forEach(e=>m.symbols.push(n(e,`char`)));else if(t(h)){let e=n(h.value,h.type);h.type===`simple`&&h.value.startsWith(`$`)&&(e.value=e.value.slice(1),e.type=`variable`),h.type===`hostExpression`&&(e.value=e.value.trim()),m.symbols.push(e)}else throw Error(`parsing advanced symbols not implemented`);m.modified=!0,h=n()}},y=()=>{if(!m.modified)return;let e={stack:m.stack.trim(),symbols:m.symbols};if(e.symbols.length===0&&e.symbols.push(n(``)),u===`reading_cause`){let n=e.symbols.at(-1);n&&t(n)&&n.value.at(-1)===`?`&&(n.value=n.value.slice(0,-1),e.keep=!0)}(u===`reading_cause`?p.causes:p.effects).push(e),p.modified=!0,m=i()},b=()=>{if(!p.modified)return;let e=a();e.causes=p.causes,e.effects=p.effects,s.rules.push(e),p=a()};for(;;){let t=e.at(c);if(!t)return v(),y(),b(),s;if(l===`find_outer_delimiter`)/\S/.test(t)&&(d=t,l=`find_inner_delimiter`,p.modified=!0);else if(l===`find_inner_delimiter`)d===t?(y(),u===`reading_cause`?u=`reading_effect`:u===`reading_effect`&&(u=`reading_cause`,b(),p.modified=!0)):/\S/.test(t)&&(f=t,l=`reading_stack_name`,m.modified=!0);else if(l===`reading_stack_name`)f===t?l=`find_symbol`:(m.stack+=t,m.modified=!0);else if(l===`find_symbol`||l===`read_symbol`)if(d===t){if(v(),y(),u===`reading_cause`)u=`reading_effect`;else if(u===`reading_effect`){if(b(),r?.stopAfterSingleRule)return s;p.modified=!0,u=`reading_cause`}l=`find_inner_delimiter`}else f===t?(v(),y(),l=`reading_stack_name`):t===`{`?(v(),l=`read_expression`,h.type=`hostExpression`):l===`find_symbol`?/\s/.test(t)||(t===`"`?(l=`read_string_symbol`,h.store=!0,h.collectingString=!0):t===`[`?(l=`read_symbol`,h.includeSpaces=!0,h.store=!0):(l=`read_symbol`,h.value+=t,h.store=!0)):l===`read_symbol`&&(/\s/.test(t)&&!h.includeSpaces||t===`]`&&h.includeSpaces?(v(),l=`find_symbol`):(h.value+=t,h.store=!0));else l===`read_string_symbol`?g?(g=!1,h.value+=t,h.store=!0):t===`\\`?(g=!0,h.value+=t,h.store=!0):t===`"`?(v(),l=`find_symbol`):(h.value+=t,h.store=!0):l===`read_expression`&&(g?(g=!1,h.value+=t,h.store=!0):t===`\\`?(g=!0,h.value+=t,h.store=!0):_.length>0&&o[_.at(-1)]===t?(_.pop(),h.value+=t,h.store=!0):t in o?(_.push(t),h.value+=t,h.store=!0):_.length===0&&t===`}`?(v(),l=`find_symbol`):(h.value+=t,h.store=!0));c++}},c=e=>{let t=s(e,{stopAfterSingleRule:!0}).rules[0];if(!t)throw Error(`Failed to parse a rule from '${e}'`);return t},l=e=>({ast:e,stacks:{},initialized:!1,variableAssignments:{}}),u=(e,{stack:t,symbols:n})=>{let{stacks:i,variableAssignments:a}=e;i[t]||(i[t]=[]),i[t].push(...n.map(t=>{if(t.type===`variable`){let e=a[t.value];if(!e)throw Error("Unexpected variable '${s.value}' had no assignment");return e}else if(t.type===`hostExpression`)return r(g(e,t.value));return t}))},d=(e,{stack:t,symbols:n,keep:r})=>{if(!e.stacks[t])throw Error(`Unexpected missing stack '${t}'`);if(e.stacks[t].length<n.length)throw Error(`Unexpected stack '${t}' had fewer items than matched symbols`);r||n.forEach(()=>v(e,t))},f=({stacks:e,variableAssignments:t},{stack:n,symbols:r})=>{if(!e[n]||e[n].length==0)return!1;for(let i=1;i<=r.length;i++){let a=e[n].at(-i),o=r.at(-i);if(!a)return!1;if(!o)throw Error(`Unexpected undefined given symbol`);if(a.type===`variable`)throw Error(`Unexpected variable on stack`);if(o.type===`variable`){if(!t[o.value])t[o.value]=a;else if(t[o.value].value!==a.value)return!1}else if(a.value!==o.value)return!1}return!0},p=e=>{rules:for(let t of e.ast.rules){if(e.variableAssignments={},t.causes.length===0)continue rules;for(let n of t.causes)if(!f(e,n))continue rules;return t}return null},m=(e,t)=>{let n=!1;for(let r of t)if(r.causes.length===0)for(let t of r.effects)n=!0,u(e,t);return n},h=e=>{if(!e.initialized)return m(e,e.ast.rules),e.initialized=!0,!0;let t=p(e);if(t===null)return!1;for(let n of t.causes)d(e,n);for(let n of t.effects)u(e,n);return!0},g=(e,t)=>{let n=[],r=[];return Object.entries(e.variableAssignments).forEach(([e,t])=>{n.push(`$`+e),r.push(t.value)}),Function(...n,`return (() => ${t})()`)(...r)},_=(e,t,n)=>{e.stacks[t]??=[],e.stacks[t].push(n)},v=(e,t)=>{let n=e.stacks[t]?.pop();return e.stacks[t]?.length===0&&delete e.stacks[t],n},y=e=>new b(typeof e==`string`?l(s(e)):e),b=class extends EventTarget{ctx;hostStepCompletedEventName=`host step completed`;hostSettledEventName=`host settled completed`;constructor(e){super(),this.ctx=e}step(){let e=h(this.ctx);return this.dispatchEvent(new Event(this.hostStepCompletedEventName)),e||this.dispatchEvent(new Event(this.hostSettledEventName)),e}settle(){let e=0;for(;e++<1e4;)if(!this.step())return;throw Error(`Infinite loop tripwire hit`)}settleWith({prepend:e,append:t}={}){let n=this.ctx.ast.rules;e&&(n.unshift(...e),m(this.ctx,e)),t&&(n.push(...t),m(this.ctx,t)),this.settle(),n.splice(0,e?.length??0);let r=t?.length??0;n.splice(-1*r,r)}onStepped(e,t){this.addEventListener(this.hostStepCompletedEventName,()=>e.call(this,this.ctx),t)}onSettled(e,t){this.addEventListener(this.hostSettledEventName,()=>e.call(this,this.ctx),t)}push(e,t){return _(this.ctx,e,t)}pop(e){return v(this.ctx,e)}},x=(e,t=` `,n=`<empty>`)=>e.length===0?n:e.map(({value:e})=>e).join(t),S=e=>{let t=[];for(let[n,r]of Object.entries(e))t.push(`:${n}: ${x(r,`, `)}`);return t.join(`
`)},C=window.$=e=>document.querySelectorAll(e),w=window.$1=e=>document.querySelector(e),T=(()=>{let e=new AbortController,t=e.signal,r=w(`script[type="application/granary"]`)?.textContent;r===void 0&&(r=``,console.warn(`No initial program found`));let i=y(r);return document.body.addEventListener(`click`,e=>{let t=e.target;if(!(t instanceof HTMLElement)||!t.matches(`[nv-onclick],[nv-onclick] *`))return;let n=t.getAttribute(`nv-onclick`);i.settleWith({prepend:s(n).rules})},{signal:t}),i.onSettled(e=>{C(`[nv-value]`).forEach(t=>{let n=t.getAttribute(`nv-value`),r=x(e.stacks[n]??[]);`value`in t?t.value=r:t.setAttribute(`value`,r)}),C(`[nv-content]`).forEach(t=>{let n=t.getAttribute(`nv-content`);t.innerHTML=x(e.stacks[n]??[])})},{signal:t}),i.onStepped(e=>{let t=c(`|:@host step: $operation $n $preposition $stackName|`).causes[0],r=c(`|:@host step: reset all stacks|`).causes[0];if(f(e,t)){d(e,t);let r=e.variableAssignments.n,i=e.variableAssignments.stackName.value,a=e.variableAssignments.operation.value;if(typeof a!=`string`)throw console.error(`Expected string operation but got:`,a),Error(`Operation was not a string, see console`);if(typeof i!=`string`)throw console.error(`Expected string stackName but got:`,i),Error(`Stack name was not a string, see console`);let o=e.stacks[i]?.pop();if(!o)throw Error(`Unexpected empty or non-existant stack '${i}'`);let s=Number(o.value);if(Number.isNaN(s))throw Error(`Unable to parse value '${o.value}' on top of stack '${i}' as Number`);let c=Number(r.value);if(Number.isNaN(c))throw Error(`Unable to parse value '${r}' on stack '${t.stack}'`);let l=s;if(a==`add`)l+=c;else if(a==`subtract`)l-=c;else if(a==`multiply`)l*=c;else if(a==`divide`)l/=c;else if(a==`mod`)l%=c;else throw Error(`Unknown operation '${a}'`);e.stacks[i].push(n(String(l)))}f(e,r)&&(d(e,r),setTimeout(()=>{e.stacks={},e.initialized=!1,i.settle()}))},{signal:t}),i.settle(),{host:i,abort:()=>e.abort(),signal:t}})();T.host.onSettled(e=>{console.log(`Stacks:`),console.log(S(e.stacks)),w(`[stacks]`).innerText=S(e.stacks)},{signal:T.signal}),T.host.settle(),w(`script[type="application/granary"]`).addEventListener(`input`,({target:e})=>{let t=w(`script[type="application/granary"]`)?.textContent;T.host.ctx.ast=s(t),T.host.settle()});