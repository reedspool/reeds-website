(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e=(e=``,t=`simple`)=>({value:e,type:t}),t=(e=``,t=[])=>({stack:e,symbols:t}),n=()=>({causes:[],effects:[]}),r=(r,i)=>{let a={rules:[]},o=0,s=`find_outer_delimiter`,c=`reading_cause`,l=null,u=null,d=n(),f=t(),p=e(),m=()=>{if(!p.store)return;let t=e(p.value);p.value.startsWith(`$`)&&(t.value=t.value.slice(1),t.type=`variable`),f.symbols.push(t),f.modified=!0,p=e()},h=()=>{if(!f.modified)return;let e=c===`reading_cause`?d.causes:d.effects,n={stack:f.stack.trim(),symbols:f.symbols};if(c===`reading_cause`){let e=n.symbols.at(-1);e?.value.at(-1)===`?`&&(e.value=e.value.slice(0,-1),n.keep=!0)}e.push(n),d.modified=!0,f=t()},g=()=>{if(!d.modified)return;let e=n();e.causes=d.causes,e.effects=d.effects,a.rules.push(e),d=n()};for(;;){let e=r.at(o);if(!e)return m(),h(),g(),a;if(s===`find_outer_delimiter`)/\S/.test(e)&&(l=e,s=`find_inner_delimiter`,d.modified=!0);else if(s===`find_inner_delimiter`)l===e?(h(),c===`reading_cause`?c=`reading_effect`:c===`reading_effect`&&(c=`reading_cause`,g(),d.modified=!0)):/\S/.test(e)&&(u=e,s=`reading_stack_name`);else if(s===`reading_stack_name`)u===e?(s=`find_symbol`,p.store=!0):(f.stack+=e,f.modified=!0);else if(s===`find_symbol`||s===`read_symbol`)if(l===e){if(m(),h(),c===`reading_cause`)c=`reading_effect`;else if(c===`reading_effect`){if(g(),i?.stopAfterSingleRule)return a;d.modified=!0,c=`reading_cause`}s=`find_inner_delimiter`}else u===e?(m(),h(),s=`reading_stack_name`):s===`find_symbol`?/\s/.test(e)||(e===`[`?(s=`read_symbol`,p.includeSpaces=!0):(s=`read_symbol`,p.value+=e,p.store=!0)):s===`read_symbol`&&(/\s/.test(e)&&!p.includeSpaces||e===`]`&&p.includeSpaces?(m(),s=`find_symbol`):(p.value+=e,p.store=!0));o++}},i=e=>{let t=r(e,{stopAfterSingleRule:!0}).rules[0];if(!t)throw Error(`Failed to parse a rule from '${e}'`);return t},a=e=>({ast:e,stacks:{},initialized:!1,variableValuesByName:{}}),o=({stacks:t,variableValuesByName:n},{stack:r,symbols:i})=>{t[r]||(t[r]=[]),t[r].push(i.map(t=>t.type===`simple`?t:e(n[t.value])))},s=({stacks:e},{stack:t,keep:n})=>{if(!e[t])throw Error(`Unexpected missing stack '${t}'`);n||e[t].pop()},c=({stacks:e,variableValuesByName:t},{stack:n,symbols:r})=>{let i=e[n]?.at(-1);if(i===void 0||i.length!==r.length)return!1;for(let e=0;e<i.length;e++){let n=i.at(e),a=r.at(e);if(!n)throw Error(`Unexpected undefined symbol on stack`);if(!a)throw Error(`Unexpected undefined given symbol`);if(n.type===`variable`)throw Error(`Unexpected variable on stack`);if(a.type===`variable`){if(!t[a.value])t[a.value]=n.value;else if(t[a.value]!==n.value)return!1}else if(n.value!==a.value)return!1}return!0},l=e=>{rules:for(let t of e.ast.rules){if(e.variableValuesByName={},t.causes.length===0)continue rules;for(let n of t.causes)if(!c(e,n))continue rules;return t}return null},u=(e,t)=>{let n=!1;for(let r of t)if(r.causes.length===0)for(let t of r.effects)n=!0,o(e,t);return n},d=e=>{if(!e.initialized)return e.initialized=!0,u(e,e.ast.rules);let t=l(e);if(t===null)return!1;for(let n of t.causes)s(e,n);for(let n of t.effects)o(e,n);return!0},f=e=>new p(typeof e==`string`?a(r(e)):e),p=class extends EventTarget{ctx;hostStepCompletedEventName=`host step completed`;hostSettledEventName=`host settled completed`;constructor(e){super(),this.ctx=e}step(){let e=d(this.ctx);return this.dispatchEvent(new Event(this.hostStepCompletedEventName)),e||this.dispatchEvent(new Event(this.hostSettledEventName)),e}settle(){let e=0;for(;e++<1e4;)if(!this.step())return;throw Error(`Infinite loop tripwire hit`)}settleWith({prepend:e,append:t}={}){let n=this.ctx.ast.rules;e&&(n.unshift(...e),u(this.ctx,e)),t&&(n.push(...t),u(this.ctx,t)),this.settle(),n.splice(0,e?.length??0);let r=t?.length??0;n.splice(-1*r,r)}onStepped(e){this.addEventListener(this.hostStepCompletedEventName,()=>e.call(this,this.ctx))}onSettled(e){this.addEventListener(this.hostSettledEventName,()=>e.call(this,this.ctx))}},m=e=>e.map(({value:e})=>e).join(` `),h=e=>{let t=[];for(let[n,r]of Object.entries(e))t.push(`:${n}: ${r.length===0?`<empty>`:r.map(e=>m(e)).join(`, `)}`);return t.join(`
`)},g=window.$=e=>document.querySelectorAll(e),_=(window.$1=e=>document.querySelector(e))(`script[type="application/granary"]`)?.textContent;_===void 0&&(_=``,console.warn(`No initial program found`));var v=f(_);document.body.addEventListener(`click`,e=>{let t=e.target;if(!(t instanceof HTMLElement)||!t.matches(`[nv-onclick],[nv-onclick] *`))return;let n=t.getAttribute(`nv-onclick`);v.settleWith({prepend:r(n).rules})}),v.onSettled(e=>{g(`[nv-value]`).forEach(t=>{let n=t.getAttribute(`nv-value`),r=m(e.stacks[n]?.at(0)??[]);`value`in t?t.value=r:t.setAttribute(`value`,r)})}),v.onStepped(t=>{let n=i(`|:@host step: $operation $n $preposition $stackName|`).causes[0];if(c(t,n)){s(t,n);let r=t.variableValuesByName.n,i=t.variableValuesByName.stackName,a=t.variableValuesByName.operation,o=t.stacks[i].pop();if(o?.length!==1)throw Error(`Expected a single value on top of stack '${i}' but instead got '${o?m(o):`undefined`}' `);let c=Number(o.at(0).value);if(Number.isNaN(c))throw Error(`Unable to parse value '${o.at(0)?.value}' on top of stack '${i}' as Number`);let l=Number(r);if(Number.isNaN(l))throw Error(`Unable to parse value '${r}' on stack '${n.stack}'`);let u=c;if(a==`add`)u+=l;else if(a==`subtract`)u-=l;else if(a==`multiply`)u*=l;else if(a==`divide`)u/=l;else if(a==`mod`)u%=l;else throw Error(`Unknown operation '${a}'`);t.stacks[i].push([e(String(u))])}console.log(`Stacks:`),console.log(h(t.stacks))}),v.settle();