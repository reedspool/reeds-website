<keep-if truthy="nocontainer !== undefined">
  <style type="text/css" media="screen">
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0.2rem;
      box-sizing: border-box;
    }
  </style>
</keep-if>
<style type="text/css" media="screen">
  edit- {
    height: 100%;
    padding: 0;
    margin: 0;
    display: grid;
    grid:
      "header"
      "toolbar"
      "textarea" 1fr
      "actionbar"
      / 1fr;

    gap: 0.4rem;

    h1 {
      grid-area: header;
    }

    toolbox- {
      grid-area: toolbar;
      display: block;
    }

    textarea {
      grid-area: textarea;
    }

    actionbar- {
      grid-area: actionbar;
      display: block;
    }
  }

  textarea {
    resize: block;
  }

  form {
    position: relative;
    display: contents;
  }

  button {
    max-width: max-content;
  }

  h1 {
    font-size: 1rem;
  }

  dialog {
    padding: 0;
    position: absolute;
    inset: unset; /* reset preset offset, upset */
    right: var(--space-phi);
    margin-top: var(--space-half);
    border: none;

    background-color: var(--bg);
    box-shadow: 0px 0px 12px -1px rgba(0, 0, 0, 0.48);

    iframe {
      border: none;
      display: block; /* maybe this should be called a bframe, amiright? */
      height: 10rem;
    }
  }
</style>
<script>
  document.addEventListener("click", ({ target }) => {
    const button = target.closest("button");
    if (!button || !button.hasAttribute("toggle-dialog-selector")) return;
    const selector = button.getAttribute("toggle-dialog-selector");
    const dialog = document.querySelector(selector);
    const wasOpen = dialog.open;
    document.querySelectorAll("dialog").forEach((dialog) => dialog.close());
    if (!wasOpen) dialog.show();
  });
</script>
<edit->
  <h1>
    Editing
    <a x-href="target" x-content="target"></a>
  </h1>

  <toolbox->
    <button
      type="button"
      title="Show Query Playground"
      toggle-dialog-selector="[query-playground]"
    >
      <code> ?q= </code>
    </button>
    <dialog query-playground closedby="none">
      <iframe
        title="Query Playground Widget"
        loading="lazy"
        src="/?contentPath=/system/templates/query.html&dialog"
      ></iframe>
    </dialog>

    <button
      type="button"
      title="Show Search and Link widget"
      toggle-dialog-selector="[search-and-link]"
    >
      <code> []() </code>
    </button>
    <button type="button" title="Insert front-matter" prepend-frontmatter>
      Add Frontmatter
    </button>
    <dialog search-and-link closedby="none">
      <iframe
        title="Query Playground Widget"
        loading="lazy"
        src="/?contentPath=/system/actions/search-and-link.html&dialog"
      ></iframe>
    </dialog>
    <a href="?delete" title="Delete this page">Delete</a>
    <keep-if truthy="nocontainer !== undefined">
      <a href="?edit" title="Edit with no container">Show container</a>
    </keep-if>
    <drop-if truthy="nocontainer !== undefined">
      <a href="?edit&nocontainer" title="Edit with no container"
        >No container</a
      >
    </drop-if>
  </toolbox->

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const textarea = document.querySelector("textarea");
      // This comes from iframes
      window.document.addEventListener("insertText", (event) => {
        const { text } = event.detail;
        const selectionStart = textarea.selectionStart;
        textarea.value =
          textarea.value.slice(0, selectionStart) +
          text +
          textarea.value.slice(textarea.selectionEnd);
        // Set selection start and end to the inserted
        textarea.selectionStart = selectionStart;
        textarea.selectionEnd = selectionStart + text.length;
      });

      document
        .querySelector("button[prepend-frontmatter]")
        .addEventListener("click", () => {
          textarea.value =
            ["---", "keywords: []", "---", ""].join("\n") + textarea.value;
        });
    });
  </script>
  <textarea
    name="content"
    spellcheck="false"
    x-content="or(editContent,'')"
  ></textarea>
  <actionbar->
    <button type="submit" x-formaction="`${target}?${saveParameters || ''}`">
      Save
    </button>
    <button
      type="submit"
      x-formaction="`${target}?redirect=${target}?edit${saveParameters || ''}`"
    >
      Save and Edit
    </button>
  </actionbar->
</edit->
